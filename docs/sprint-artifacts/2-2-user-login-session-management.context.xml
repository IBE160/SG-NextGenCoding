<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>user-login-and-session-management</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a registered user,</asA>
    <iWant>I want to log in to my account,</iWant>
    <soThat>so that I can access my saved content and continue my learning journey.</soThat>
    <tasks>
      <task group="Backend: Create User Login Endpoint" ac-refs="1">
        <subtask>Create a new API route in FastAPI under `backend/app/api/auth/login.py`.</subtask>
        <subtask>The endpoint should accept email and password and use Supabase `signInWithPassword`.</subtask>
        <subtask>On successful login, it should return the session/JWT to the client.</subtask>
        <subtask>Handle login errors (e.g., invalid credentials) gracefully.</subtask>
      </task>
      <task group="Frontend: Build Login UI Form" ac-refs="1">
        <subtask>Create the login page component at `frontend/src/app/(auth)/login/page.tsx`.</subtask>
        <subtask>Build the form using Shadcn UI components, consistent with the registration form.</subtask>
        <subtask>Implement form state management with `React Hook Form` and validation with `Zod`.</subtask>
      </task>
      <task group="Frontend: Handle Login and Session" ac-refs="2">
        <subtask>On form submission, call the backend login endpoint.</subtask>
        <subtask>Securely store the returned session/JWT (e.g., in an HttpOnly cookie).</subtask>
        <subtask>Redirect the user to a dashboard or home page on successful login.</subtask>
      </task>
      <task group="Frontend: Implement Protected Routes" ac-refs="3, 4">
        <subtask>Create a Next.js middleware file (`frontend/src/middleware.ts`) to handle route protection.</subtask>
        <subtask>The middleware should check for a valid session cookie.</subtask>
        <subtask>If the session is invalid, redirect the user to the login page.</subtask>
        <subtask>Create an example protected page (e.g., `frontend/src/app/dashboard/page.tsx`) to test the functionality.</subtask>
      </task>
      <task group="Testing">
        <subtask>Write a backend unit test for the login endpoint.</subtask>
        <subtask>Write frontend integration tests for the login flow and for accessing a protected route (both authenticated and unauthenticated states).</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <item id="1">**Given** I have a registered account from Story 2.1, **When** I enter my correct email and password on the login page, **Then** I am authenticated via Supabase Auth.</item>
    <item id="2">**And** a session (e.g., JWT in a cookie) is established, allowing me access to protected routes.</item>
    <item id="3">**Given** I am logged in, **When** I visit a protected route, **Then** I can access the content.</item>
    <item id="4">**Given** I am not logged in, **When** I attempt to visit a protected route, **Then** I am redirected to the login page.</item>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Authentication &amp; Authorization</section>
        <snippet>Supabase Auth will manage authentication using JWTs, email/password registration, login, verification, and password reset. Row Level Security (RLS) will be strictly enforced in Supabase to ensure robust authorization.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Security Architecture</section>
        <snippet>Authentication: Supabase Auth (JWT-based, email/password, email verification, password reset). Authorization: Supabase Row Level Security (RLS) for data, backend API route protection.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.2: User Login and Session Management</section>
        <snippet>As a registered user, I want to log in to my account, so that I can access my saved content and continue my learning journey.</snippet>
      </doc>
    </docs>
    <code>
      <reference>
        <path>backend/app/api/auth/login.py</path>
        <reason>Primary location for the backend login endpoint logic.</reason>
      </reference>
      <reference>
        <path>frontend/src/app/(auth)/login/page.tsx</path>
        <reason>Main UI component for the user login form.</reason>
      </reference>
      <reference>
        <path>frontend/src/middleware.ts</path>
        <reason>Location for Next.js middleware to handle route protection.</reason>
      </reference>
    </code>
    <dependencies>
      <dependency name="Supabase" version="latest">
        <reason>Used for authentication (sign-in) and user management.</reason>
      </dependency>
      <dependency name="FastAPI" version="latest">
        <reason>Backend framework for creating the API endpoint.</reason>
      </dependency>
      <dependency name="Next.js" version="latest">
        <reason>Frontend framework, used for UI and middleware-based route protection.</reason>
      </dependency>
      <dependency name="React Hook Form" version="latest">
        <reason>Used for client-side form state management in the login UI.</reason>
      </dependency>
      <dependency name="Zod" version="latest">
        <reason>Used for client-side form validation.</reason>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>Structure Pattern</type>
      <description>Tests co-located with code. Frontend components organized by feature. Backend organized by domain/feature. Shared utilities in dedicated `lib/`, `core/`, or `shared/` directories.</description>
      <source>docs/architecture.md#Structure-Patterns</source>
    </constraint>
  </constraints>
  <interfaces>
    <api-contract>
      <endpoint>POST /api/auth/login</endpoint>
      <description>Authenticates a user and returns a session.</description>
      <request>
        <payload>
          <field name="email" type="string" required="true">User's email address.</field>
          <field name="password" type="string" required="true">User's password.</field>
        </payload>
      </request>
      <response status="200 OK">
        <description>User successfully authenticated. Session is returned.</description>
        <payload>
          <field name="access_token" type="string">The JWT for the session.</field>
          <field name="token_type" type="string">"bearer"</field>
        </payload>
      </response>
      <response status="401 Unauthorized">
        <description>Invalid credentials provided.</description>
      </response>
      <response status="422 Unprocessable Entity">
        <description>Invalid input data (e.g., invalid email format).</description>
      </response>
    </api-contract>
  </interfaces>
  <tests>
    <standards>Unit tests for both frontend and backend code to ensure individual components function correctly. Integration tests to verify interactions between frontend and backend API, and backend and AI service.</standards>
    <locations>
      <location>frontend/tests/</location>
      <location>backend/tests/</location>
    </locations>
    <ideas>
      <idea ac-ref="1">Write a backend unit test for the login endpoint.</idea>
      <idea ac-ref="3,4">Write frontend integration tests for the login flow and for accessing a protected route (both authenticated and unauthenticated states).</idea>
    </ideas>
  </tests>
</story-context>
