<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>4</storyId>
    <title>password-reset-and-email-verification</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a user,</asA>
    <iWant>I want to reset my password if I forget it and verify my email address,</iWant>
    <soThat>so that I can maintain access to my account and ensure its security.</soThat>
    <tasks>
      <task group="Backend: Password Reset Request Endpoint" ac-refs="1">
        <subtask>Create an API endpoint (e.g., `POST /api/auth/forgot-password`) that accepts a user's email.</subtask>
        <subtask>The endpoint should call the Supabase Auth function to trigger the password recovery email (e.g., `auth.resetPasswordForEmail`).</subtask>
      </task>
      <task group="Frontend: 'Forgot Password' UI" ac-refs="1">
        <subtask>Create a "Forgot Password" page at `frontend/src/app/(auth)/forgot-password/page.tsx`.</subtask>
        <subtask>The page should have a form with an email input field and a submit button.</subtask>
        <subtask>On submit, call the backend endpoint.</subtask>
      </task>
      <task group="Backend: Password Update Endpoint" ac-refs="2">
        <subtask>Supabase handles the password update via its redirect flow. A backend endpoint may be needed to handle the callback from Supabase to finalize the password update if not handled client-side.</subtask>
      </task>
      <task group="Frontend: 'Reset Password' UI" ac-refs="2">
        <subtask>Create a "Reset Password" page at `frontend/src/app/(auth)/reset-password/page.tsx`.</subtask>
        <subtask>This page will be loaded when the user clicks the link in their email. It will handle the token from Supabase.</subtask>
        <subtask>The form will allow the user to enter and confirm their new password.</subtask>
      </task>
      <task group="Frontend: Email Verification Handling" ac-refs="3">
        <subtask>Create a specific callback page (e.g., `frontend/src/app/auth/callback/page.tsx`) to handle the redirect from Supabase after a user clicks the verification link.</subtask>
        <subtask>This page should inform the user that their email has been verified and direct them to the login page.</subtask>
      </task>
      <task group="Testing">
        <subtask>Write integration tests for the full password reset flow.</subtask>
        <subtask>Write a test to ensure the email verification callback route works as expected.</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <item id="1">**Given** I have an account but have forgotten my password, **When** I request a password reset from the "Forgot Password" page, **Then** I receive an email with a password reset link.</item>
    <item id="2">**And** upon clicking the link and submitting a new password, my password is changed, and I can log in with the new password.</item>
    <item id="3">**Given** I have just registered for a new account, **When** I click the link in my verification email, **Then** my email address is marked as verified in the system.</item>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Authentication &amp; Authorization</section>
        <snippet>Email verification and password reset flows.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Security Architecture</section>
        <snippet>Authentication: Supabase Auth (JWT-based, email/password, email verification, password reset).</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.4: Password Reset and Email Verification</section>
        <snippet>As a user, I want to reset my password if I forget it and verify my email address, so that I can maintain access to my account and ensure its security.</snippet>
      </doc>
    </docs>
    <code></code>
    <dependencies></dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>Consistency Rule</type>
      <description>All new UI pages must be consistent with the existing auth UI.</description>
      <source>docs/sprint-artifacts/2-4-password-reset-email-verification.md#Dev-Notes</source>
    </constraint>
  </constraints>
  <interfaces></interfaces>
  <tests>
    <standards>Integration tests to verify interactions between frontend and backend API.</standards>
    <locations>
      <location>frontend/tests/</location>
      <location>backend/tests/</location>
    </locations>
    <ideas>
      <idea ac-ref="1,2">Write integration tests for the full password reset flow.</idea>
      <idea ac-ref="3">Write a test to ensure the email verification callback route works as expected.</idea>
    </ideas>
  </tests>
</story-context>
