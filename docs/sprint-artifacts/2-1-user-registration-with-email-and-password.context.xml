<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>user-registration-with-email-and-password</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a new user,</asA>
    <iWant>I want to create an account using my email and a secure password,</iWant>
    <soThat>so that I can access personalized features and save my progress.</soThat>
    <tasks>
      <task group="Backend: Create User Registration Endpoint" ac-refs="1">
        <subtask>Create a new API route in FastAPI under `backend/app/api/auth/register.py`.</subtask>
        <subtask>The endpoint should accept email and password.</subtask>
        <subtask>Implement logic to call `supabase.auth.sign_up()` with the provided credentials.</subtask>
        <subtask>Handle potential errors from Supabase (e.g., user already exists) and return appropriate HTTP status codes.</subtask>
      </task>
      <task group="Backend: Integrate Email Service for Confirmation" ac-refs="2">
        <subtask>Configure the `Resend` email service in the backend.</subtask>
        <subtask>After a successful sign-up, trigger an email to be sent to the user's email address for confirmation.</subtask>
      </task>
      <task group="Frontend: Build Registration UI Form" ac-refs="1, 4">
        <subtask>Create the registration page component at `frontend/src/app/(auth)/register/page.tsx`.</subtask>
        <subtask>Build the form using Shadcn UI components (`Input`, `Button`, `Label`). Reuse the button from `frontend/components/ui/button.tsx`.</subtask>
        <subtask>Implement client-side form state management with `React Hook Form`.</subtask>
      </task>
      <task group="Frontend: Implement Form Validation" ac-refs="4">
        <subtask>Define a `Zod` schema for registration form validation (email, password, confirm password).</subtask>
        <subtask>Integrate the Zod schema with `React Hook Form` to provide real-time validation feedback.</subtask>
      </task>
      <task group="Frontend: Handle Form Submission" ac-refs="1, 3">
        <subtask>On form submission, call the backend registration endpoint.</subtask>
        <subtask>On success, redirect the user to a "check your email" page or the login page.</subtask>
        <subtask>On failure, display a user-friendly error message (e.g., using a Toast component).</subtask>
      </task>
      <task group="Testing">
        <subtask>Write a backend unit test for the registration endpoint.</subtask>
        <subtask>Write a frontend integration test for the registration form, covering success and failure cases.</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <item id="1">**Given** I am on the registration page, **When** I provide a valid email and a secure password (and confirm password), **Then** my account is successfully created in Supabase Auth.</item>
    <item id="2">**And** a confirmation email is sent to my provided email address.</item>
    <item id="3">**And** I am redirected to a success page or login page after registration.</item>
    <item id="4">**Given** the registration form, **When** I submit invalid data (e.g., mismatched passwords, invalid email format), **Then** I see clear, inline validation errors.</item>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Authentication &amp; Authorization</section>
        <snippet>Supabase Auth will manage authentication using JWTs, email/password registration, login, verification, and password reset. Row Level Security (RLS) will be strictly enforced in Supabase to ensure robust authorization.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Epic to Architecture Mapping</section>
        <snippet>| Epic 2: User Access & Authentication | frontend/src/app/(auth)/, frontend/src/lib/supabase.ts, backend/app/api/auth/ (if needed), backend/app/core/security.py. Supabase (external). |</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.1: User Registration with Email and Password</section>
        <snippet>As a new user, I want to create an account using my email and a secure password, so that I can access personalized features and save my progress.</snippet>
      </doc>
    </docs>
    <code>
      <reference>
        <path>backend/app/api/auth/register.py</path>
        <reason>Primary location for the backend registration endpoint logic.</reason>
      </reference>
      <reference>
        <path>frontend/src/app/(auth)/register/page.tsx</path>
        <reason>Main UI component for the user registration form.</reason>
      </reference>
    </code>
    <dependencies>
      <dependency name="Supabase" version="latest">
        <reason>Used for authentication (sign-up) and user management.</reason>
      </dependency>
      <dependency name="FastAPI" version="latest">
        <reason>Backend framework for creating the API endpoint.</reason>
      </dependency>
      <dependency name="React Hook Form" version="latest">
        <reason>Used for client-side form state management in the registration UI.</reason>
      </dependency>
      <dependency name="Zod" version="latest">
        <reason>Used for client-side form validation.</reason>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>Naming Convention</type>
      <description>API Endpoints: plural nouns, kebab-case. Route Parameters: {id} format. Database Tables/Columns: plural, snake_case. Frontend Components: PascalCase (components), kebab-case (file names).</description>
      <source>docs/architecture.md#Naming-Conventions</source>
    </constraint>
  </constraints>
  <interfaces>
    <api-contract>
      <endpoint>POST /api/v1/auth/register</endpoint>
      <description>Creates a new user account.</description>
      <request>
        <payload>
          <field name="email" type="string" required="true">User's email address.</field>
          <field name="password" type="string" required="true">User's chosen password.</field>
        </payload>
      </request>
      <response status="201 Created">
        <description>User successfully created. A confirmation email is sent.</description>
        <payload>
          <field name="message" type="string">"User created successfully. Please check your email for verification."</field>
        </payload>
      </response>
      <response status="409 Conflict">
        <description>A user with this email already exists.</description>
      </response>
      <response status="422 Unprocessable Entity">
        <description>Invalid input data (e.g., invalid email format, weak password).</description>
      </response>
    </api-contract>
  </interfaces>
  <tests>
    <standards>Unit tests for both frontend and backend code to ensure individual components function correctly. Integration tests to verify interactions between frontend and backend API, and backend and AI service.</standards>
    <locations>
      <location>frontend/tests/</location>
      <location>backend/tests/</location>
    </locations>
    <ideas>
      <idea ac-ref="1">Write a backend unit test for the registration endpoint.</idea>
      <idea ac-ref="4">Write a frontend integration test for the registration form, covering success and failure cases.</idea>
    </ideas>
  </tests>
  <review-comments>
    <comment type="summary">Implementation is functional but has deviations from the story-context.xml and areas for improvement in user experience and robustness.</comment>
    <comment type="file" path="backend/app/main.py">
      <detail type="deviation">Mounts auth router at /api/v1/auth. story-context.xml specifies /api/auth.</detail>
    </comment>
    <comment type="file" path="backend/app/api/auth/register.py">
      <detail type="inconsistency">Handles unconfirmed users with a 201 Created and a message, which is ambiguous. A 200 OK would be clearer.</detail>
      <detail type="improvement">Generic except Exception leaks internal error details to the client. Should return a generic error message.</detail>
      <detail type="inconsistency">Password validation is for 6 characters, while the frontend requires 8.</detail>
    </comment>
    <comment type="file" path="frontend/src/app/(auth)/register/page.tsx">
      <detail type="improvement">Lacks a loading indicator on submission, allowing for potential multiple clicks.</detail>
      <detail type="improvement">Uses a simple text field for API errors instead of the recommended Toast component.</detail>
      <detail type="inconsistency">zod schema requires an 8-character password.</detail>
    </comment>
    <comment type="recommendation">Align API Path: Update docs/sprint-artifacts/2-1-user-registration-with-email-and-password.context.xml to change POST /api/auth/register to POST /api/v1/auth/register.</detail>
    <comment type="recommendation">Unify Password Rule: Standardize password length to 8 characters across both register.py and page.tsx.</detail>
    <comment type="recommendation">Refine Backend Logic: Change the response for unconfirmed users to 200 OK. Mask detailed server errors in the final except block.</detail>
    <comment type="recommendation">Enhance Frontend UX: Add a disabled/loading state to the submit button. Replace the error div with a Toast notification.</detail>
  </review-comments>
</story-context>
