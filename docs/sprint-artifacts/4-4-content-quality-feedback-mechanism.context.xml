<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>4</storyId>
    <title>Content Quality Feedback Mechanism</title>
    <status>drafted</status>
    <generatedAt>mandag 8. desember 2025</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-4-content-quality-feedback-mechanism.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user,</asA>
    <iWant>to provide feedback on the quality of AI-generated summaries and quizzes,</iWant>
    <soThat>the system can continuously improve.</soThat>
    <tasks>- [ ] Task 1 (AC: #1, #2) - Backend for Feedback Submission
  - [ ] Subtask 1.1 - Create a new Supabase table to store feedback (e.g., `feedback` table with columns for `content_id`, `user_id`, `rating`, `comment`).
  - [ ] Subtask 1.2 - Implement RLS policies for the `feedback` table.
  - [ ] Subtask 1.3 - Create a FastAPI endpoint to receive and store feedback submissions.
- [ ] Task 2 (AC: #1) - Frontend for Feedback Collection
  - [ ] Subtask 2.1 - Design and implement a feedback component (e.g., a modal or a small inline form) with rating (stars) and a comment field.
  - [ ] Subtask 2.2 - Integrate the feedback component into the summary and quiz results views.
  - [ ] Subtask 2.3 - Implement the client-side logic to submit the feedback to the backend API.</tasks>
  </story>

  <acceptanceCriteria>1.  **Given** I am viewing a generated summary or quiz, **When** I click a "Rate this" or "Report Issue" button, **Then** a simple feedback form appears (e.g., 1-5 stars, free text comment).
2.  My feedback is securely recorded.</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Product Scope - MVP - Minimum Viable Product - Content Feedback</section>
        <snippet>A simple 'Rate this' or 'Report Issue' mechanism for users to provide feedback on the quality of AI-generated content.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements - 3. Interactive Learning &amp; Assessment (FR-ILA) - FR-ILA-2: Content Feedback</section>
        <snippet>The system shall provide a simple mechanism for users to rate the quality/accuracy of AI-generated summaries and quizzes (e.g., 'helpful/not helpful,' 'report issue' button). Users can easily submit feedback on both summaries and quizzes. Feedback data is securely recorded for system analysis and improvement.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Domain-Specific Requirements - Ethical AI Use</section>
        <snippet>Ethical considerations around bias in summaries or quizzes, fairness in grading, and transparency of AI operation will be paramount.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Non-Functional Requirements - Security</section>
        <snippet>All user-generated content must be sanitized before rendering to prevent cross-site scripting (XSS) attacks.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Epic to Architecture Mapping - Epic 4: Interactive Quiz Generation &amp; Feedback</section>
        <snippet>frontend/src/app/quizzes/, frontend/src/services/, backend/app/api/quizzes/, backend/app/services/ai_generation/, backend/app/db/, backend/app/schemas/.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Technology Stack Details - Database &amp; Auth: Supabase</section>
        <snippet>Supabase (PostgreSQL for DB, Supabase Auth for Authentication, Supabase-js 2.84.0, Supabase-py 2.24.0)</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>API Contracts</section>
        <snippet>Style: RESTful API. Response Format: Wrapped payload for success, standardized error format. Authentication: JWT tokens via Supabase Auth. Error Handling: HTTP status codes, consistent error body.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Security Architecture - Authorization</section>
        <snippet>Supabase Row Level Security (RLS) for data, backend API route protection.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Epic 4: Interactive Quiz Generation &amp; Feedback - Story 4.4: Content Quality Feedback Mechanism</section>
        <snippet>As a user, I want to provide feedback on the quality of AI-generated summaries and quizzes, so that the system can continuously improve.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/app/db/models.py</path>
        <kind>model</kind>
        <symbol>Quiz</symbol>
        <reason>Existing model for quizzes, new feedback table/model will follow a similar pattern.</reason>
      </artifact>
      <artifact>
        <path>backend/app/db/models.py</path>
        <kind>model</kind>
        <symbol>Question</symbol>
        <reason>Existing model for quiz questions.</reason>
      </artifact>
      <artifact>
        <path>backend/app/db/models.py</path>
        <kind>field</kind>
        <symbol>feedback</symbol>
        <reason>Existing feedback field in another model, shows precedent for feedback data types.</reason>
      </artifact>
      <artifact>
        <path>backend/app/services/ai_generation/quiz_generator.py</path>
        <kind>service</kind>
        <symbol>generate_quiz</symbol>
        <reason>Core service for quiz generation, feedback could be related to its output.</reason>
      </artifact>
      <artifact>
        <path>backend/app/services/ai_generation/quiz_generator.py</path>
        <kind>service</kind>
        <symbol>grade_quiz</symbol>
        <reason>Service for grading quizzes, relevant if feedback is tied to quiz performance.</reason>
      </artifact>
      <artifact>
        <path>backend/app/schemas/quiz.py</path>
        <kind>schema</kind>
        <reason>Pydantic schemas for quiz-related data, feedback schema will follow this pattern.</reason>
      </artifact>
      <artifact>
        <path>backend/app/api/quizzes/main.py</path>
        <kind>endpoint</kind>
        <reason>FastAPI endpoints for quiz operations, feedback endpoint will be similar.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/components/quiz/GenerateQuizButton.tsx</path>
        <kind>component</kind>
        <reason>Frontend component for generating quizzes; feedback might be provided after generation.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/components/quiz/QuestionCard.tsx</path>
        <kind>component</kind>
        <reason>Frontend component for displaying quiz questions.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/components/quiz/QuizView.tsx</path>
        <kind>component</kind>
        <reason>Main quiz viewing component, feedback button will be integrated here.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/components/quiz/ResultsView.tsx</path>
        <kind>component</kind>
        <reason>Quiz results viewing component, feedback button will be integrated here.</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency_group type="frontend">
        <package name="@hookform/resolvers" version="^5.2.2" />
        <package name="@next/bundle-analyzer" version="^16.0.7" />
        <package name="@radix-ui/react-dialog" version="^1.1.15" />
        <package name="@radix-ui/react-dropdown-menu" version="^2.0.6" />
        <package name="@radix-ui/react-icons" version="^1.3.0" />
        <package name="@radix-ui/react-label" version="^2.1.8" />
        <package name="@radix-ui/react-slot" version="^1.0.2" />
        <package name="@radix-ui/react-toast" version="^1.2.15" />
        <package name="@supabase/ssr" version="^0.1.0" />
        <package name="@supabase/supabase-js" version="^2.39.3" />
        <package name="@tanstack/react-query" version="^5.17.15" />
        <package name="@tanstack/react-query-devtools" version="^5.17.15" />
        <package name="@types/uuid" version="^11.0.0" />
        <package name="@vercel/analytics" version="^1.1.1" />
        <package name="axios" version="^1.6.5" />
        <package name="class-variance-authority" version="^0.7.0" />
        <package name="clsx" version="^2.1.0" />
        <package name="geist" version="^1.0.0" />
        <package name="lucide-react" version="^0.304.0" />
        <package name="next" version="^16.0.7" />
        <package name="next-themes" version="^0.4.6" />
        <package name="nextjs-toploader" version="^3.9.17" />
        <package name="react" version="18.2.0" />
        <package name="react-copy-to-clipboard" version="^5.1.0" />
        <package name="react-dom" version="18.2.0" />
        <package name="react-hook-form" version="^7.67.0" />
        <package name="react-markdown" version="^9.1.0" />
        <package name="tailwind-merge" version="^2.2.0" />
        <package name="undici" version="^5.28.2" />
        <package name="uuid" version="^13.0.0" />
        <package name="zod" version="^4.1.13" />
        <package name="zustand" version="5.0.8" />
      </dependency_group>
      <dependency_group type="backend">
        <package name="fastapi" version="^0.122.0" />
        <package name="uvicorn" version="^0.38.0" />
        <package name="supabase" version="^2.24.0" />
        <package name="gotrue" version="^2.11.3" />
        <package name="python-dotenv" version="^1.2.1" />
        <package name="email-validator" version="^2.1.1" />
        <package name="pydantic-settings" version="^2.12.0" />
        <package name="sqlalchemy" version="^2.0.44" />
        <package name="sqlmodel" version="^0.0.27" />
        <package name="psycopg2-binary" version="^2.9.11" />
        <package name="asyncpg" version="^0.31.0" />
        <package name="pypdf" version="^6.4.0" />
        <package name="python-docx" version="^1.2.0" />
        <package name="google-generativeai" version="^0.7.1" />
        <package name="tenacity" version="^8.5.0" />
        <package name="python-multipart" version="^0.0.20" />
      </dependency_group>
    </dependencies>
  <constraints>
      <constraint>
        <type>Security</type>
        <description>All user-generated content must be sanitized before rendering to prevent cross-site scripting (XSS) attacks. (Source: docs/PRD.md)</description>
      </constraint>
      <constraint>
        <type>RLS</type>
        <description>Row Level Security (RLS) will be rigorously applied within Supabase to ensure users can only access their own data, providing robust authorization. (Source: docs/architecture.md)</description>
      </constraint>
      <constraint>
        <type>Ethical AI Use</type>
        <description>Ethical considerations around bias in summaries or quizzes, fairness in grading, and transparency of AI operation will be paramount. (Source: docs/PRD.md)</description>
      </constraint>
      <constraint>
        <type>API Contracts</type>
        <description>Style: RESTful API. Response Format: Wrapped payload for success, standardized error format. Authentication: JWT tokens via Supabase Auth. Error Handling: HTTP status codes, consistent error body. (Source: docs/architecture.md)</description>
      </constraint>
    </constraints>
    <interfaces>
      <interface>
        <name>Supabase Table</name>
        <kind>Database Table</kind>
        <signature>New `feedback` table with columns for `content_id`, `user_id`, `rating`, `comment`.</signature>
        <path>backend/migrations/</path>
      </interface>
      <interface>
        <name>Feedback Submission API</name>
        <kind>REST endpoint</kind>
        <signature>POST /api/v1/feedback</signature>
        <path>backend/app/api/endpoints/</path>
      </interface>
    </interfaces>
  <tests>
    <standards>
      <standard>Unit Tests: Both frontend and backend code will be covered by unit tests to ensure individual components function correctly.</standard>
      <standard>Integration Tests: Integration tests will be written to verify the interactions between different parts of the system, such as the frontend and backend API, and the backend and the AI service.</standard>
      <standard>End-to-End (E2E) Tests: E2E tests will simulate user journeys to ensure the entire application works as expected.</standard>
    </standards>
    <locations>
      <location>frontend/__tests__/</location>
      <location>backend/tests/</location>
    </locations>
    <ideas>
      <idea>
        <type>Unit Test (Backend)</type>
        <description>Test feedback API endpoint validation (e.g., invalid rating, missing fields).</description>
        <ac_id>1, 2</ac_id>
      </idea>
      <idea>
        <type>Unit Test (Backend)</type>
        <description>Test Supabase table insertion for feedback.</description>
        <ac_id>2</ac_id>
      </idea>
      <idea>
        <type>Unit Test (Backend)</type>
        <description>Test RLS policies for feedback data.</description>
        <ac_id>2</ac_id>
      </idea>
      <idea>
        <type>Unit Test (Frontend)</type>
        <description>Test feedback component rendering.</description>
        <ac_id>1</ac_id>
      </idea>
      <idea>
        <type>Unit Test (Frontend)</type>
        <description>Test feedback form submission logic.</description>
        <ac_id>1</ac_id>
      </idea>
      <idea>
        <type>Integration Test</type>
        <description>Test submitting feedback from the UI to the API and verifying its persistence in Supabase.</description>
        <ac_id>1, 2</ac_id>
      </idea>
      <idea>
        <type>E2E Test</type>
        <description>Simulate a user viewing a summary/quiz, clicking the feedback button, filling the form, submitting, and verifying the feedback is recorded.</description>
        <ac_id>1, 2</ac_id>
      </idea>
    </ideas>
  </tests>
</story-context>